<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RESET Client Tracker</title>

  <!-- Chart.js (for improved dashboard) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- EmailJS (for sending emails) -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>

  <style>
    /* ---------------------------------------------------------
       General / Layout
    --------------------------------------------------------- */
    body {
      background-color: #EAF6FF;
      font-family: sans-serif;
      margin: 20px;
      max-width: 720px;
    }
    h1, h2 {
      margin-bottom: 0.5em;
    }
    select, input[type="date"] {
      font-size: 1em;
      margin-right: 0.5em;
    }
    .btn {
      cursor: pointer;
      padding: 0.4em 0.8em;
      margin: 0.5em 0.3em 0.5em 0;
      border: 1px solid #ccc;
      background-color: #f5f5f5;
    }

    /* Title Bar */
    .title-bar {
      background-color: #BCDDFE;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 1em;
    }

    /* Controls Area */
    .controls {
      margin-bottom: 1em;
    }
    .controls > * {
      margin-bottom: 5px;
    }

    /* New client form */
    #newClientForm {
      display: none;
      margin: 10px 0;
      padding: 10px;
      background-color: #f0f8ff;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* Mobile responsiveness */
    @media (max-width: 600px) {
      body {
        margin: 10px;
      }
      .controls {
        display: flex;
        flex-direction: column;
      }
      .controls select, .controls input, .controls button {
        margin-bottom: 10px;
        width: 100%;
      }
    }

    /* ---------------------------------------------------------
       Task Table
    --------------------------------------------------------- */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      background-color: #fff;
      font-size: 0.95em;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 0.5em;
      text-align: left;
      vertical-align: middle;
    }
    .task-row input[type="checkbox"] {
      transform: scale(1.2);
      cursor: pointer;
    }

    /* Completed-task styling */
    .completed-task {
      text-decoration: line-through;
      color: #888;
      background-color: #f8f8f8;
    }

    /* ---------------------------------------------------------
       Progress Dashboard
    --------------------------------------------------------- */
    #progressDashboard {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      background-color: #fefefe;
    }
    /* We’ll have cards for each chart or metric */
    .dashboard-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .progress-card {
      flex: 1 1 260px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      min-width: 220px;
    }
    .progress-card h4 {
      margin-top: 0;
      margin-bottom: 0.5em;
    }

    /* ---------------------------------------------------------
       Modals
    --------------------------------------------------------- */
    /* Multi-day planner modal */
    #plannerModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 100;
    }
    .modal-content {
      background-color: #fff;
      margin: 50px auto;
      padding: 20px;
      width: 80%;
      max-width: 600px;
      border-radius: 5px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .day-plan {
      margin-bottom: 15px;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 4px;
    }

    /* Weekly planner modal */
    #weeklyModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 100;
    }
    .weekly-modal-content {
      background-color: #fff;
      margin: 50px auto;
      padding: 20px;
      width: 80%;
      max-width: 800px;
      border-radius: 5px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .weekly-day-section {
      margin-bottom: 15px;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #fafafa;
      border-radius: 4px;
    }
    .weekly-day-section h4 {
      margin-top: 0;
    }

    /* Image modal */
    #imageModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 100;
    }
    .image-modal-content {
      background-color: #fff;
      margin: 50px auto;
      padding: 20px;
      width: 90%;
      max-width: 700px;
      border-radius: 5px;
      max-height: 80vh;
      overflow-y: auto;
    }
    #imagePreview {
      max-width: 100%;
      max-height: 200px;
      margin-top: 10px;
      display: block;
      border: 1px solid #ccc;
    }

    /* ---------------------------------------------------------
       Image Gallery
    --------------------------------------------------------- */
    #imageGallery {
      margin-top: 20px;
      padding: 10px;
      background-color: #fefefe;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .gallery-item {
      margin-bottom: 10px;
    }
    .gallery-item img {
      max-width: 200px;
      margin-right: 10px;
      vertical-align: middle;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .gallery-item .title {
      font-weight: bold;
    }

    /* Time Container in "Add New Task" */
    .time-container {
      display: flex;
      gap: 10px;
    }

    /* ---------------------------------------------------------
       Footer
    --------------------------------------------------------- */
    #footer {
      margin-top: 2em;
      font-size: 0.9em;
      color: #666;
    }

  </style>
</head>
<body>
<div class="title-bar">
  <h1>RESET Client Tracker</h1>
</div>

<div class="controls">
  <!-- Client selection -->
  <label><strong>Client:</strong></label>
  <select id="clientSelect"></select>
  <button class="btn" id="addClientBtn">+ Add Client</button>

  <!-- Date selection -->
  <label><strong>Date:</strong></label>
  <input type="date" id="datePicker" />

  <!-- Buttons: Clear tasks, Export, Report -->
  <button class="btn" id="clearTasksBtn">Clear Tasks</button>
  <button class="btn" id="exportBtn">Export Data</button>
  <button class="btn" id="reportBtn">View Report</button>

  <!-- Multi-day, Weekly plan, Images, Email -->
  <button class="btn" id="multiDayPlanBtn">Multi-Day Plan</button>
  <button class="btn" id="weeklyPlanBtn">Weekly Plan</button>
  <button class="btn" id="imageBtn">Add Image</button>
  <button class="btn" id="sendEmailBtn">Email Plan</button>
</div>

<!-- New client form -->
<div id="newClientForm">
  <label><strong>New Client Name:</strong></label>
  <input type="text" id="newClientName" placeholder="Enter client name">
  <button class="btn" id="saveClientBtn">Save</button>
  <button class="btn" id="cancelClientBtn">Cancel</button>
</div>

<!-- Day rating dropdown -->
<div style="margin-bottom:1em;">
  <label><strong>Day Rating (1–5):</strong></label>
  <select id="dayRatingSelect" class="rating-dropdown">
    <option value="0">--</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>
</div>

<!-- Quick daily notes -->
<div style="margin-bottom:1em;">
  <label><strong>Daily Notes:</strong></label><br/>
  <textarea id="dayNotes" rows="3" style="width:98%;" placeholder="Any quick notes for today..."></textarea>
  <br/>
</div>

<hr/>

<h2>Add New Task</h2>
<div class="time-container">
  <div>
    <label for="timeSelect">Time:</label>
    <select id="timeSelect" class="time-dropdown"></select>
  </div>
  <div>
    <label for="durationSelect">Duration:</label>
    <select id="durationSelect">
      <option value="5 min">5 minutes</option>
      <option value="10 min">10 minutes</option>
      <option value="15 min">15 minutes</option>
      <option value="30 min" selected>30 minutes</option>
      <option value="45 min">45 minutes</option>
      <option value="1 hour">1 hour</option>
      <option value="90 min">90 minutes</option>
      <option value="2 hours">2 hours</option>
    </select>
  </div>
</div>
<br>

<label for="activityInput">Activity:</label>
<input type="text" id="activityInput" style="width:98%;" placeholder="e.g. Work on Chemistry assignment" />
<br><br>
<div style="margin-bottom:10px;">
  <input type="text" id="taskSearch" placeholder="Search tasks..." style="width:50%;">
</div>
<button class="btn" id="addBtn">Add Task</button>

<table id="taskTable">
  <thead>
    <tr>
      <th style="width:15%">Time</th>
      <th style="width:35%">Activity</th>
      <th style="width:10%">Done?</th>
      <th style="width:15%">Task Rating</th>
      <th style="width:25%">Actions</th>
    </tr>
  </thead>
  <tbody>
    <!-- Rows dynamically inserted here -->
  </tbody>
</table>

<!-- Image gallery area -->
<div id="imageGallery"></div>

<!-- Progress Dashboard -->
<div id="progressDashboard">
  <h3>Progress Dashboard</h3>
  
  <div class="dashboard-cards">
    <!-- Card 1: Task Completion Chart -->
    <div class="progress-card">
      <h4>Task Completion</h4>
      <canvas id="completionChart" width="200" height="200"></canvas>
    </div>
    <!-- Card 2: Day Rating History -->
    <div class="progress-card">
      <h4>Day Rating History</h4>
      <canvas id="ratingChart" width="200" height="200"></canvas>
    </div>
  </div>
</div>

<!-- Multi-Day Planner Modal -->
<div id="plannerModal">
  <div class="modal-content">
    <h3>Multi-Day Task Planner</h3>
    
    <p>Create a series of tasks across multiple days</p>
    
    <div id="plannerDays">
      <!-- Day plans will be added here -->
    </div>
    
    <button class="btn" id="addDayBtn">Add Another Day</button>
    
    <div style="margin-top:20px;">
      <button class="btn" id="savePlanBtn">Save All Tasks</button>
      <button class="btn" id="cancelPlanBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Weekly Plan Modal -->
<div id="weeklyModal">
  <div class="weekly-modal-content">
    <h3>Weekly Planner for: <span id="weeklyClientLabel"></span></h3>
    <p>Set tasks for each weekday. These tasks will appear automatically on those days.</p>
    
    <div id="weeklyContent"></div>
    
    <div style="margin-top:20px;">
      <button class="btn" id="saveWeeklyBtn">Save Weekly Schedule</button>
      <button class="btn" id="cancelWeeklyBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imageModal">
  <div class="image-modal-content">
    <h3>Add an Image / Screenshot</h3>
    
    <div>
      <input type="file" id="imageFileInput" accept="image/*">
      <p style="color:#666;font-size:0.9em;">
        Or paste a screenshot directly (click here, then Ctrl+V).
      </p>
    </div>
    
    <img id="imagePreview" src="" alt="(Preview will appear here)" style="display:none;">
    
    <div style="margin-top:10px;">
      <label>Image Title:</label><br/>
      <input type="text" id="imageTitle" style="width:90%;">
    </div>
    
    <div style="margin-top:10px;">
      <button class="btn" id="saveImageBtn">Save Image</button>
      <button class="btn" id="cancelImageBtn">Cancel</button>
    </div>
  </div>
</div>

<div id="footer">
  <p>Data is stored in your browser's localStorage, keyed by client AND date. Add day notes, tasks, etc.</p>
  <p style="font-size: 0.8em; color:#444;">
    <em>Save as plain-text .html, then open in your web browser.</em>
  </p>
</div>

<script>
/***************************************************************
  0) INIT EmailJS
  Make sure to replace placeholders with real values from
  your EmailJS account.
***************************************************************/
(function(){
  emailjs.init("YOUR_EMAILJS_USER_ID"); 
})();

/***************************************************************
  1) CLIENT LIST
****************************************************************/
const clientNames = [
  "Giancarlo","Walter","Brendan B","Kai","Rafferty","Bardez",
  "KariBella","Zeb","Griffin","Charlie","Troy","Owen",
  "Sean","Bethany","DannyMike","Zelda","Whoadie"
];

/***************************************************************
  2) DATA STRUCTURE (localStorage key: "multiClientDateData")
     allData[clientName][dateStr] = {
       dayRating: "0",
       dayNotes: "",
       tasks: [...]
     }

     allData[clientName].weeklyTasks = {
       monday: [],
       tuesday: [],
       wednesday: [],
       thursday: [],
       friday: [],
       saturday: [],
       sunday: []
     }

     allData[clientName].images = [ { title, dataUrl }, ... ]
****************************************************************/
let allData = {};
let currentClient = null;
let currentDate   = null;

// DOM references
const clientSelect        = document.getElementById("clientSelect");
const datePicker          = document.getElementById("datePicker");
const clearTasksBtn       = document.getElementById("clearTasksBtn");
const exportBtn           = document.getElementById("exportBtn");
const reportBtn           = document.getElementById("reportBtn");
const multiDayPlanBtn     = document.getElementById("multiDayPlanBtn");
const weeklyPlanBtn       = document.getElementById("weeklyPlanBtn");
const imageBtn            = document.getElementById("imageBtn");
const sendEmailBtn        = document.getElementById("sendEmailBtn");

const dayRatingSelect     = document.getElementById("dayRatingSelect");
const dayNotesTextarea    = document.getElementById("dayNotes");
const timeSelect          = document.getElementById("timeSelect");
const durationSelect      = document.getElementById("durationSelect");
const activityInput       = document.getElementById("activityInput");
const taskSearch          = document.getElementById("taskSearch");
const addBtn              = document.getElementById("addBtn");
const taskTableBody       = document.getElementById("taskTable").querySelector("tbody");

// New client elements
const addClientBtn        = document.getElementById("addClientBtn");
const newClientForm       = document.getElementById("newClientForm");
const newClientName       = document.getElementById("newClientName");
const saveClientBtn       = document.getElementById("saveClientBtn");
const cancelClientBtn     = document.getElementById("cancelClientBtn");

// Multi-day planner elements
const plannerModal        = document.getElementById("plannerModal");
const plannerDays         = document.getElementById("plannerDays");
const addDayBtn           = document.getElementById("addDayBtn");
const savePlanBtn         = document.getElementById("savePlanBtn");
const cancelPlanBtn       = document.getElementById("cancelPlanBtn");

// Weekly planner elements
const weeklyModal         = document.getElementById("weeklyModal");
const weeklyClientLabel   = document.getElementById("weeklyClientLabel");
const weeklyContent       = document.getElementById("weeklyContent");
const saveWeeklyBtn       = document.getElementById("saveWeeklyBtn");
const cancelWeeklyBtn     = document.getElementById("cancelWeeklyBtn");

// Image elements
const imageModal          = document.getElementById("imageModal");
const imageFileInput      = document.getElementById("imageFileInput");
const imagePreview        = document.getElementById("imagePreview");
const imageTitleInput     = document.getElementById("imageTitle");
const saveImageBtn        = document.getElementById("saveImageBtn");
const cancelImageBtn      = document.getElementById("cancelImageBtn");
const imageGallery        = document.getElementById("imageGallery");

// Chart references (we'll create them in code)
let completionChart = null;
let ratingChart     = null;

/***************************************************************
  3) ON WINDOW LOAD
****************************************************************/
window.addEventListener("load", () => {
  // Load from localStorage
  const stored = localStorage.getItem("multiClientDateData");
  if (stored) {
    allData = JSON.parse(stored);
  }
  // Ensure each client has weeklyTasks + images
  clientNames.forEach(name => {
    if (!allData[name]) {
      allData[name] = {};
    }
    if (!allData[name].weeklyTasks) {
      allData[name].weeklyTasks = {
        monday: [], tuesday: [], wednesday: [], thursday: [],
        friday: [], saturday: [], sunday: []
      };
    }
    if (!allData[name].images) {
      allData[name].images = [];
    }
  });

  // Populate client dropdown
  populateClientDropdown();

  // Default: first client, date = today
  clientSelect.value = clientNames[0];
  currentClient = clientSelect.value;
  const todayStr = (new Date()).toISOString().split("T")[0];
  datePicker.value = todayStr;
  currentDate = todayStr;

  // Event listeners
  clientSelect.addEventListener("change", onClientOrDateChange);
  datePicker.addEventListener("change", onClientOrDateChange);
  dayRatingSelect.addEventListener("change", onDayRatingChange);
  dayNotesTextarea.addEventListener("input", onDayNotesChange);
  addBtn.addEventListener("click", addNewTask);
  clearTasksBtn.addEventListener("click", clearTasksForClientDate);
  exportBtn.addEventListener("click", exportData);
  reportBtn.addEventListener("click", generateReport);

  // New client listeners
  addClientBtn.addEventListener("click", showNewClientForm);
  saveClientBtn.addEventListener("click", saveNewClient);
  cancelClientBtn.addEventListener("click", hideNewClientForm);

  // Multi-day planner listeners
  multiDayPlanBtn.addEventListener("click", openPlannerModal);
  addDayBtn.addEventListener("click", addPlannerDay);
  savePlanBtn.addEventListener("click", saveMultiDayPlan);
  cancelPlanBtn.addEventListener("click", closePlannerModal);

  // Weekly plan listeners
  weeklyPlanBtn.addEventListener("click", openWeeklyModal);
  saveWeeklyBtn.addEventListener("click", saveWeeklySchedule);
  cancelWeeklyBtn.addEventListener("click", closeWeeklyModal);

  // Image listeners
  imageBtn.addEventListener("click", openImageModal);
  cancelImageBtn.addEventListener("click", closeImageModal);
  saveImageBtn.addEventListener("click", saveImage);
  imageModal.addEventListener("paste", handlePasteImage);
  imageFileInput.addEventListener("change", handleFileInputChange);

  // Email button
  sendEmailBtn.addEventListener("click", sendEmail);

  // Task search
  taskSearch.addEventListener("input", function() {
    const searchText = this.value.toLowerCase();
    const rows = taskTableBody.querySelectorAll("tr");
    rows.forEach(row => {
      const activity = row.cells[1].textContent.toLowerCase();
      row.style.display = activity.includes(searchText) ? "" : "none";
    });
  });

  // Build time dropdown
  populateTimeDropdown();

  // Keyboard shortcuts
  setupKeyboardShortcuts();

  // Load data for initial client/date
  loadClientDate(currentClient, currentDate);

  // Init charts
  initCharts();
});

/***************************************************************
  4) POPULATE CLIENT DROPDOWN
****************************************************************/
function populateClientDropdown() {
  clientSelect.innerHTML = "";
  clientNames.sort().forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    clientSelect.appendChild(opt);
  });
}

/***************************************************************
  5) ADD NEW CLIENT
****************************************************************/
function showNewClientForm() {
  newClientForm.style.display = "block";
  newClientName.value = "";
  newClientName.focus();
}

function hideNewClientForm() {
  newClientForm.style.display = "none";
}

function saveNewClient() {
  const name = newClientName.value.trim();
  if (!name) {
    alert("Please enter a client name");
    return;
  }
  if (clientNames.includes(name)) {
    alert(`Client "${name}" already exists`);
    return;
  }
  clientNames.push(name);
  if (!allData[name]) {
    allData[name] = {};
  }
  if (!allData[name].weeklyTasks) {
    allData[name].weeklyTasks = {
      monday: [], tuesday: [], wednesday: [], thursday: [],
      friday: [], saturday: [], sunday: []
    };
  }
  if (!allData[name].images) {
    allData[name].images = [];
  }
  
  populateClientDropdown();
  clientSelect.value = name;
  currentClient = name;
  loadClientDate(currentClient, currentDate);
  
  hideNewClientForm();
  saveToLocalStorage();
}

/***************************************************************
  6) KEYBOARD SHORTCUTS
****************************************************************/
function setupKeyboardShortcuts() {
  document.addEventListener("keydown", function(e) {
    // Alt+A = Add Task
    if (e.altKey && e.key === "a") {
      e.preventDefault();
      addNewTask();
    }
    // Alt+D = Toggle last daily task as done
    if (e.altKey && e.key === "d") {
      e.preventDefault();
      const lastRow = taskTableBody.querySelector("tr:last-child");
      if (lastRow) {
        const checkbox = lastRow.querySelector("input[type='checkbox']");
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event("change"));
      }
    }
    // Alt+S = Sort tasks by time
    if (e.altKey && e.key === "s") {
      e.preventDefault();
      sortTasksByTime();
    }
  });
}

/***************************************************************
  7) CLIENT/DATE CHANGE
****************************************************************/
function onClientOrDateChange() {
  currentClient = clientSelect.value;
  currentDate   = datePicker.value;
  loadClientDate(currentClient, currentDate);
}

/***************************************************************
  8) LOAD A CLIENT+DATE
****************************************************************/
function loadClientDate(clientName, dateStr) {
  if (!allData[clientName][dateStr]) {
    allData[clientName][dateStr] = { dayRating:"0", dayNotes:"", tasks:[] };
    saveToLocalStorage();
  }
  const rec = allData[clientName][dateStr];

  // Set rating & notes
  dayRatingSelect.value    = rec.dayRating || "0";
  dayNotesTextarea.value   = rec.dayNotes || "";

  // Rebuild tasks table
  taskTableBody.innerHTML = "";
  // Daily tasks
  const tasks = rec.tasks || [];
  tasks.forEach(t => addTaskRow(t));
  // Weekly tasks
  const weekday = getWeekdayFromDate(dateStr);
  const weeklyList = allData[clientName].weeklyTasks[weekday] || [];
  weeklyList.forEach(wTask => addWeeklyTaskRow(wTask, dateStr));

  // Render images
  renderImageGallery();

  // Update charts
  updateCharts();
}

/***************************************************************
  9) DAY RATING CHANGE
****************************************************************/
function onDayRatingChange() {
  const rec = allData[currentClient][currentDate];
  if (!rec) return;
  rec.dayRating = dayRatingSelect.value;
  saveToLocalStorage();
  updateCharts();
}

/***************************************************************
  10) DAY NOTES CHANGE
****************************************************************/
function onDayNotesChange() {
  const rec = allData[currentClient][currentDate];
  if (!rec) return;
  rec.dayNotes = dayNotesTextarea.value;
  saveToLocalStorage();
}

/***************************************************************
  11) TIME DROPDOWN
****************************************************************/
function populateTimeDropdown() {
  timeSelect.innerHTML = "";
  // 15-min intervals, 5am - 11pm
  for (let hour=5; hour<24; hour++) {
    for (let minute=0; minute<60; minute+=15) {
      const suffix = (hour<12) ? "AM" : "PM";
      let displayHour = hour%12;
      if (displayHour === 0) displayHour = 12;
      const minStr = minute===0 ? "00" : String(minute);
      const label = `${displayHour}:${minStr} ${suffix}`;
      const opt = document.createElement("option");
      opt.value = label;
      opt.textContent = label;
      timeSelect.appendChild(opt);
    }
  }
  // separator
  const sep = document.createElement("option");
  sep.disabled = true;
  sep.textContent = "---- Common Times ----";
  timeSelect.appendChild(sep);
  // Common blocks
  const commonTimes = [
    "Before School","During Study Hall","During Lunch",
    "Right After School","Before Dinner","After Dinner","Before Bed"
  ];
  commonTimes.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    timeSelect.appendChild(opt);
  });
}

/***************************************************************
  12) ADD NEW TASK
****************************************************************/
function addNewTask() {
  if (!currentClient || !currentDate) return;
  const actVal = activityInput.value.trim();
  if (!actVal) {
    alert("Please fill in the Activity field.");
    return;
  }
  const rec = allData[currentClient][currentDate];
  const newTask = {
    time: timeSelect.value,
    activity: actVal,
    completed: false,
    rating: "0",
    duration: durationSelect.value
  };
  rec.tasks.push(newTask);
  saveToLocalStorage();
  activityInput.value = "";
  // Refresh table
  addTaskRow(newTask);
  updateCharts();
  // Sort tasks
  sortTasksByTime();
}

/***************************************************************
  13) ADD TASK ROW (daily)
****************************************************************/
function addTaskRow(taskObj) {
  const row = taskTableBody.insertRow();
  row.classList.add("task-row");
  if (taskObj.completed) row.classList.add("completed-task");

  // Time
  const tdTime = row.insertCell(0);
  tdTime.innerHTML = taskObj.time;
  if (taskObj.duration) {
    tdTime.innerHTML += `<br><span style="font-size:0.8em; color:#666;">${taskObj.duration}</span>`;
  }

  // Activity
  const tdAct = row.insertCell(1);
  tdAct.textContent = taskObj.activity;

  // Done?
  const tdComp = row.insertCell(2);
  const chk = document.createElement("input");
  chk.type = "checkbox";
  chk.checked = taskObj.completed;
  chk.addEventListener("change", () => {
    taskObj.completed = chk.checked;
    row.classList.toggle("completed-task", chk.checked);
    saveToLocalStorage();
    updateCharts();
  });
  tdComp.appendChild(chk);

  // Rating
  const tdRating = row.insertCell(3);
  const selRate = document.createElement("select");
  selRate.classList.add("rating-dropdown");
  const opt0 = document.createElement("option");
  opt0.value="0"; opt0.text="--";
  selRate.appendChild(opt0);
  for (let i=1; i<=5; i++){
    const o = document.createElement("option");
    o.value=String(i); o.text=String(i);
    selRate.appendChild(o);
  }
  selRate.value = taskObj.rating;
  selRate.addEventListener("change", () => {
    taskObj.rating = selRate.value;
    saveToLocalStorage();
    updateCharts();
  });
  tdRating.appendChild(selRate);

  // Actions
  const tdActions = row.insertCell(4);
  const editBtn = document.createElement("button");
  editBtn.textContent = "✎";
  editBtn.classList.add("btn");
  editBtn.style.marginRight = "6px";
  editBtn.addEventListener("click", () => makeTaskEditable(row, taskObj));
  tdActions.appendChild(editBtn);

  const removeBtn = document.createElement("button");
  removeBtn.textContent = "X";
  removeBtn.classList.add("btn");
  removeBtn.addEventListener("click", () => {
    removeTask(taskObj);
    row.remove();
    updateCharts();
  });
  tdActions.appendChild(removeBtn);
}

/***************************************************************
  13b) ADD WEEKLY TASK ROW (non-editable from daily)
****************************************************************/
function addWeeklyTaskRow(weeklyTask, dateStr) {
  const row = taskTableBody.insertRow();
  row.classList.add("task-row");

  // Check if done for this date
  const rec = allData[currentClient][dateStr];
  if (!rec.weeklyDone) rec.weeklyDone = {};
  const wasDone = !!rec.weeklyDone[weeklyTask.id];
  if (wasDone) row.classList.add("completed-task");

  // Time
  const tdTime = row.insertCell(0);
  tdTime.innerHTML = `(Weekly) ${weeklyTask.time}`;
  if (weeklyTask.duration) {
    tdTime.innerHTML += `<br><span style="font-size:0.8em; color:#666;">${weeklyTask.duration}</span>`;
  }

  // Activity
  const tdAct = row.insertCell(1);
  tdAct.textContent = weeklyTask.activity;

  // Done?
  const tdComp = row.insertCell(2);
  const chk = document.createElement("input");
  chk.type="checkbox";
  chk.checked=wasDone;
  chk.addEventListener("change", () => {
    rec.weeklyDone[weeklyTask.id] = chk.checked;
    row.classList.toggle("completed-task", chk.checked);
    saveToLocalStorage();
    updateCharts();
  });
  tdComp.appendChild(chk);

  // Rating
  const tdRating = row.insertCell(3);
  tdRating.textContent = "--"; // or "(weekly)"

  // Actions
  const tdActions = row.insertCell(4);
  tdActions.innerHTML = `<em style="color:#999;">(Edit in Weekly Plan)</em>`;
}

/***************************************************************
  14) MAKE TASK EDITABLE
****************************************************************/
function makeTaskEditable(row, taskObj) {
  const tdTime = row.cells[0];
  const tdAct  = row.cells[1];
  const oldTime = taskObj.time;
  const oldAct  = taskObj.activity;
  const oldDuration = taskObj.duration || "30 min";

  // Time + duration
  tdTime.innerHTML = "";
  const newTimeSelect = document.createElement("select");
  populateTempTimeDropdown(newTimeSelect, oldTime);
  tdTime.appendChild(newTimeSelect);

  const newDurSelect = document.createElement("select");
  ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"]
    .forEach(dur => {
      const opt = document.createElement("option");
      opt.value = dur; opt.text = dur;
      newDurSelect.appendChild(opt);
    });
  newDurSelect.value = oldDuration;
  tdTime.appendChild(document.createElement("br"));
  tdTime.appendChild(newDurSelect);

  // Activity
  tdAct.innerHTML = "";
  const actField = document.createElement("input");
  actField.type="text";
  actField.value=oldAct;
  actField.style.width="98%";
  tdAct.appendChild(actField);

  // Actions
  const tdActions = row.cells[4];
  const oldActionsHTML = tdActions.innerHTML;
  tdActions.innerHTML="";

  const saveBtn = document.createElement("button");
  saveBtn.textContent = "Save";
  saveBtn.classList.add("btn");
  saveBtn.addEventListener("click", () => {
    const newT = newTimeSelect.value;
    const newA = actField.value.trim();
    const newD = newDurSelect.value;
    if(!newA){ alert("Activity cannot be empty."); return; }
    taskObj.time = newT;
    taskObj.activity = newA;
    taskObj.duration = newD;
    saveToLocalStorage();
    row.classList.remove("editing");
    // rebuild row
    const idx = Array.from(taskTableBody.rows).indexOf(row);
    row.remove();
    const newRow = taskTableBody.insertRow(idx);
    addTaskRow(taskObj);
    // resort
    sortTasksByTime();
    updateCharts();
  });
  tdActions.appendChild(saveBtn);

  actField.focus();
}

function populateTempTimeDropdown(sel, currentVal) {
  const masterOpts = timeSelect.options;
  for (let i=0; i<masterOpts.length; i++){
    sel.appendChild(masterOpts[i].cloneNode(true));
  }
  sel.value = currentVal;
}

/***************************************************************
  15) SORT TASKS BY TIME
****************************************************************/
function sortTasksByTime() {
  const rec = allData[currentClient][currentDate];
  if(!rec || !rec.tasks) return;
  rec.tasks.sort((a,b)=>convertTimeToMinutes(a.time) - convertTimeToMinutes(b.time));
  saveToLocalStorage();
  loadClientDate(currentClient, currentDate);
}

function convertTimeToMinutes(tstr) {
  const special = {
    "Before School":360,"During Study Hall":600,"During Lunch":720,
    "Right After School":840,"Before Dinner":1020,"After Dinner":1140,"Before Bed":1320
  };
  if(special[tstr]) return special[tstr];
  try {
    const [timePart,ampm] = tstr.split(" ");
    if(!timePart||!ampm) return 9999;
    let [hh,mm] = timePart.split(":").map(Number);
    if(isNaN(hh)||isNaN(mm))return 9999;
    if(ampm.toUpperCase()==="PM" && hh<12) hh+=12;
    if(ampm.toUpperCase()==="AM" && hh===12) hh=0;
    return hh*60+mm;
  } catch(e) {
    return 9999;
  }
}

/***************************************************************
  16) REMOVE TASK
****************************************************************/
function removeTask(taskObj) {
  const rec = allData[currentClient][currentDate];
  const idx = rec.tasks.indexOf(taskObj);
  if(idx>=0) {
    rec.tasks.splice(idx,1);
    saveToLocalStorage();
  }
}

/***************************************************************
  17) CLEAR TASKS
****************************************************************/
function clearTasksForClientDate() {
  if(!currentClient||!currentDate)return;
  if(confirm(`Clear ALL tasks for ${currentClient} on ${currentDate}?`)) {
    allData[currentClient][currentDate].tasks=[];
    saveToLocalStorage();
    loadClientDate(currentClient, currentDate);
  }
}

/***************************************************************
  18) EXPORT JSON
****************************************************************/
function exportData() {
  const dataStr = JSON.stringify(allData,null,2);
  const dataUri = "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);
  const link = document.createElement("a");
  link.href=dataUri;
  link.download=`planner-export-${(new Date()).toISOString().split('T')[0]}.json`;
  link.click();
}

/***************************************************************
  19) SAVE (error handling)
****************************************************************/
function saveToLocalStorage() {
  try {
    localStorage.setItem("multiClientDateData", JSON.stringify(allData));
  } catch(e) {
    if(e.name==="QuotaExceededError") {
      alert("Storage limit exceeded. Please export data & clear old entries.");
    } else {
      console.error("Error saving:", e);
      alert("Problem saving data; changes may not persist.");
    }
  }
}

/***************************************************************
  20) CHARTS (Improved Progress Dashboard)
****************************************************************/
function initCharts() {
  // Completion chart: doughnut
  const ctx1 = document.getElementById("completionChart").getContext("2d");
  completionChart = new Chart(ctx1, {
    type: "doughnut",
    data: {
      labels: ["Done","Not Done"],
      datasets: [{
        data: [0,0],
        backgroundColor:["#4CAF50","#ccc"]
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false
    }
  });

  // Day rating chart: bar (show multiple past days)
  const ctx2 = document.getElementById("ratingChart").getContext("2d");
  ratingChart = new Chart(ctx2, {
    type: "bar",
    data: {
      labels: [],  // will hold date strings
      datasets: [{
        label: "Day Rating",
        data: [],
        backgroundColor:"#2196F3"
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales: {
        y: {
          min:0,
          max:5,
          ticks: {
            stepSize:1
          }
        }
      }
    }
  });
}

function updateCharts() {
  // 1) Update completion chart
  const rec = allData[currentClient][currentDate];
  if(!rec) return;
  const tasks = rec.tasks || [];

  // Count daily done
  const dailyDone = tasks.filter(t=>t.completed).length;
  // Weekly tasks for today
  const wd = getWeekdayFromDate(currentDate);
  const weeklyList = allData[currentClient].weeklyTasks[wd] || [];
  const weeklyDoneMap = rec.weeklyDone || {};
  const weeklyDone = weeklyList.filter(wt=>weeklyDoneMap[wt.id]).length;

  const totalDone = dailyDone + weeklyDone;
  const totalTasks= tasks.length + weeklyList.length;
  
  // Update doughnut data
  if(totalTasks>0) {
    completionChart.data.datasets[0].data = [totalDone, totalTasks - totalDone];
  } else {
    completionChart.data.datasets[0].data = [0,1]; // no tasks => 0% done
  }
  completionChart.update();

  // 2) Update day rating chart (bar). Show all known dates up to currentDate
  const allDates = Object.keys(allData[currentClient])
    .filter(d => /^\d{4}-\d{2}-\d{2}$/.test(d))
    .sort();

  // Build arrays for labels + rating
  const labels = [];
  const ratings= [];
  allDates.forEach(d => {
    const r = allData[currentClient][d].dayRating;
    const val = (r && r!=="0") ? parseInt(r,10) : 0;
    labels.push(d);
    ratings.push(val);
  });
  ratingChart.data.labels = labels;
  ratingChart.data.datasets[0].data = ratings;
  ratingChart.update();
}

function getWeekdayFromDate(dstr) {
  const d=new Date(dstr);
  const idx=d.getDay(); //0=Sun..6=Sat
  const map=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];
  return map[idx];
}

/***************************************************************
  21) MULTI-DAY PLANNER
****************************************************************/
function openPlannerModal() {
  plannerDays.innerHTML="";
  addPlannerDay();
  plannerModal.style.display="block";
}
function closePlannerModal() {
  plannerModal.style.display="none";
}

function addPlannerDay() {
  const dayCount = plannerDays.querySelectorAll(".day-plan").length;
  const baseDate = new Date(currentDate);
  baseDate.setDate(baseDate.getDate()+dayCount);
  const dStr = baseDate.toISOString().split("T")[0];

  const div = document.createElement("div");
  div.className="day-plan";
  div.dataset.date = dStr;

  const lbl = document.createElement("h4");
  lbl.textContent=`Day ${dayCount+1}: ${formatDate(dStr)}`;
  div.appendChild(lbl);

  const container = document.createElement("div");
  const timeLab = document.createElement("label");
  timeLab.textContent="Time:";
  container.appendChild(timeLab);

  const timeSel = document.createElement("select");
  populateTempTimeDropdown(timeSel,"3:00 PM");
  container.appendChild(timeSel);

  const durLab = document.createElement("label");
  durLab.textContent="Duration:";
  durLab.style.marginLeft="10px";
  container.appendChild(durLab);

  const durSel = document.createElement("select");
  ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"]
    .forEach(d=>{
      const opt = document.createElement("option");
      opt.value=d; opt.text=d;
      durSel.appendChild(opt);
    });
  durSel.value="30 min";
  container.appendChild(durSel);

  div.appendChild(container);

  const actLab = document.createElement("label");
  actLab.textContent="Activity:";
  actLab.style.display="block";
  actLab.style.marginTop="10px";
  div.appendChild(actLab);

  const actInput = document.createElement("input");
  actInput.type="text";
  actInput.placeholder="e.g. Complete Math assignment";
  actInput.style.width="100%";
  div.appendChild(actInput);

  const addTaskBtn = document.createElement("button");
  addTaskBtn.textContent="Add Another Task to this Day";
  addTaskBtn.className="btn";
  addTaskBtn.style.marginTop="10px";
  addTaskBtn.addEventListener("click",()=>{
    const newContainer = container.cloneNode(true);
    const newActLab = actLab.cloneNode(true);
    const newActInput = actInput.cloneNode(true);
    newActInput.value="";
    div.insertBefore(document.createElement("hr"), addTaskBtn);
    div.insertBefore(newContainer, addTaskBtn);
    div.insertBefore(newActLab, addTaskBtn);
    div.insertBefore(newActInput, addTaskBtn);
  });
  div.appendChild(addTaskBtn);

  plannerDays.appendChild(div);
}

function saveMultiDayPlan() {
  const dayPlans = plannerDays.querySelectorAll(".day-plan");
  let tasksAdded=0;

  dayPlans.forEach(plan=>{
    const dStr=plan.dataset.date;
    if(!allData[currentClient][dStr]){
      allData[currentClient][dStr] = { dayRating:"0", dayNotes:"", tasks:[] };
    }
    const rec=allData[currentClient][dStr];
    const actInputs = plan.querySelectorAll('input[type="text"]');
    const selects   = plan.querySelectorAll('select');

    actInputs.forEach((inp, i)=>{
      const val = inp.value.trim();
      if(val){
        const timeIdx = i*2;
        const durIdx  = i*2+1;
        const time = selects[timeIdx]?.value||"3:00 PM";
        const dur  = selects[durIdx]?.value||"30 min";
        rec.tasks.push({
          time:time,
          activity:val,
          completed:false,
          rating:"0",
          duration:dur
        });
        tasksAdded++;
      }
    });
  });

  saveToLocalStorage();
  loadClientDate(currentClient, currentDate);
  closePlannerModal();
  alert(`Multi-day plan created! ${tasksAdded} tasks added total.`);
}

function formatDate(dStr) {
  const d=new Date(dStr);
  return d.toLocaleDateString(undefined,{ weekday:'short', month:'short', day:'numeric'});
}

/***************************************************************
  22) WEEKLY PLANNER
****************************************************************/
function openWeeklyModal() {
  weeklyClientLabel.textContent=currentClient;
  buildWeeklyContent();
  weeklyModal.style.display="block";
}
function closeWeeklyModal() {
  weeklyModal.style.display="none";
}

function buildWeeklyContent() {
  weeklyContent.innerHTML="";
  const days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];
  const wData=allData[currentClient].weeklyTasks;

  days.forEach(d=>{
    const sec = document.createElement("div");
    sec.classList.add("weekly-day-section");
    const hd = document.createElement("h4");
    hd.textContent = capitalize(d);
    sec.appendChild(hd);

    const dayTasks = wData[d];
    const tasksDiv = document.createElement("div");

    dayTasks.forEach(task=>{
      const row=document.createElement("div");
      row.style.marginBottom="5px";
      row.textContent=`[${task.time}] ${task.activity}`;

      const rmBtn=document.createElement("button");
      rmBtn.textContent="X";
      rmBtn.classList.add("btn");
      rmBtn.style.marginLeft="10px";
      rmBtn.addEventListener("click",()=>{
        const idx=dayTasks.indexOf(task);
        if(idx!==-1){
          dayTasks.splice(idx,1);
          saveToLocalStorage();
          buildWeeklyContent();
        }
      });
      row.appendChild(rmBtn);
      tasksDiv.appendChild(row);
    });
    sec.appendChild(tasksDiv);

    // Add row
    const addRow=document.createElement("div");
    addRow.style.marginTop="10px";

    const timeSel=document.createElement("select");
    populateTempTimeDropdown(timeSel,"3:00 PM");
    addRow.appendChild(timeSel);

    const durSel=document.createElement("select");
    ["5 min","10 min","15 min","30 min","45 min","1 hour","90 min","2 hours"]
      .forEach(dur=>{
        const opt=document.createElement("option");
        opt.value=dur; opt.text=dur;
        durSel.appendChild(opt);
      });
    durSel.value="30 min";
    addRow.appendChild(durSel);

    const actInp=document.createElement("input");
    actInp.type="text";
    actInp.placeholder="Activity...";
    actInp.style.width="220px";
    actInp.style.marginLeft="5px";
    addRow.appendChild(actInp);

    const plusBtn=document.createElement("button");
    plusBtn.textContent="+";
    plusBtn.classList.add("btn");
    plusBtn.style.marginLeft="10px";
    plusBtn.addEventListener("click",()=>{
      const val=actInp.value.trim();
      if(!val){ alert("Please enter an activity."); return; }
      const newId=`weekly_${Date.now()}_${Math.floor(Math.random()*1000)}`;
      dayTasks.push({
        id:newId,
        time: timeSel.value,
        duration: durSel.value,
        activity: val
      });
      saveToLocalStorage();
      buildWeeklyContent();
    });
    addRow.appendChild(plusBtn);

    sec.appendChild(addRow);
    weeklyContent.appendChild(sec);
  });
}

function saveWeeklySchedule() {
  closeWeeklyModal();
  loadClientDate(currentClient, currentDate);
  alert("Weekly schedule saved!");
}

function capitalize(str){
  return str.charAt(0).toUpperCase()+str.slice(1);
}

/***************************************************************
  IMAGES
****************************************************************/
function openImageModal() {
  imageFileInput.value="";
  imagePreview.src="";
  imagePreview.style.display="none";
  imageTitleInput.value="";
  imageModal.style.display="block";
}
function closeImageModal() {
  imageModal.style.display="none";
}
function handleFileInputChange() {
  const file=imageFileInput.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=(e)=>{
    imagePreview.src=e.target.result;
    imagePreview.style.display="block";
  };
  reader.readAsDataURL(file);
}
function handlePasteImage(e) {
  const items=e.clipboardData?.items||[];
  for(let i=0;i<items.length;i++){
    if(items[i].type.indexOf("image")===0){
      const file=items[i].getAsFile();
      if(file){
        const reader=new FileReader();
        reader.onload=(evt)=>{
          imagePreview.src=evt.target.result;
          imagePreview.style.display="block";
        };
        reader.readAsDataURL(file);
      }
    }
  }
}
function saveImage() {
  if(!imagePreview.src){
    alert("No image to save!");
    return;
  }
  const title=imageTitleInput.value.trim()||"(Untitled)";
  allData[currentClient].images.push({
    title:title,
    dataUrl:imagePreview.src
  });
  saveToLocalStorage();
  closeImageModal();
  renderImageGallery();
}
function renderImageGallery() {
  imageGallery.innerHTML="";
  const imgs=allData[currentClient].images||[];
  if(imgs.length===0) return;
  
  const h3=document.createElement("h3");
  h3.textContent="Image Gallery";
  imageGallery.appendChild(h3);

  imgs.forEach((imgObj,idx)=>{
    const div=document.createElement("div");
    div.classList.add("gallery-item");
    const title=document.createElement("span");
    title.classList.add("title");
    title.textContent=imgObj.title+" ";
    div.appendChild(title);

    const thumb=document.createElement("img");
    thumb.src=imgObj.dataUrl;
    thumb.style.maxHeight="60px";
    thumb.style.cursor="pointer";
    thumb.addEventListener("click",()=>window.open(imgObj.dataUrl,"_blank"));
    div.appendChild(thumb);

    const rmBtn=document.createElement("button");
    rmBtn.textContent="X";
    rmBtn.classList.add("btn");
    rmBtn.style.marginLeft="10px";
    rmBtn.addEventListener("click",()=>{
      if(confirm("Remove this image?")){
        imgs.splice(idx,1);
        saveToLocalStorage();
        renderImageGallery();
      }
    });
    div.appendChild(rmBtn);

    imageGallery.appendChild(div);
  });
}

/***************************************************************
  23) EMAIL THE PLAN (Using EmailJS)
****************************************************************/
function sendEmail() {
  // 1) Make sure we have an EmailJS setup
  //    Fill in your actual SERVICE_ID, TEMPLATE_ID, etc.
  const SERVICE_ID = "YOUR_SERVICE_ID";
  const TEMPLATE_ID= "YOUR_TEMPLATE_ID";

  // 2) Gather data for the current date
  const rec = allData[currentClient][currentDate];
  if(!rec) {
    alert("No data to send.");
    return;
  }

  // Build a simple HTML list of tasks
  let dailyTaskList = "<ul>";
  (rec.tasks||[]).forEach(t=>{
    dailyTaskList += `<li>${t.time} - ${t.activity} (done: ${t.completed ? "yes" : "no"})</li>`;
  });
  dailyTaskList+="</ul>";

  // Weekly tasks for that day
  const weekday = getWeekdayFromDate(currentDate);
  const weeklyList = allData[currentClient].weeklyTasks[weekday]||[];
  let weeklyTaskList="";
  if(weeklyList.length>0){
    weeklyTaskList="<ul>";
    weeklyList.forEach(wt=>{
      const isDone = (rec.weeklyDone && rec.weeklyDone[wt.id]) ? "yes":"no";
      weeklyTaskList+=`<li>(weekly) ${wt.time} - ${wt.activity} (done: ${isDone})</li>`;
    });
    weeklyTaskList+="</ul>";
  }

  const templateParams = {
    to_name:      "Mom", // Or any recipient name
    clientName:   currentClient,
    dateValue:    currentDate,
    dayRating:    rec.dayRating || "--",
    dayNotes:     rec.dayNotes || "",
    dailyTasksHtml: dailyTaskList,
    weeklyTasksHtml: weeklyTaskList
  };

  // 3) Send via EmailJS
  emailjs.send(SERVICE_ID, TEMPLATE_ID, templateParams)
    .then(resp=>{
      alert("Email sent successfully!");
    })
    .catch(err=>{
      console.error("Email send error:", err);
      alert("Error sending email.");
    });
}
</script>
</body>
</html>
